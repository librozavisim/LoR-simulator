import random

from logic.character_changing.passives.base_passive import BasePassive


# ==========================================
# 2.1 Примечательный
# ==========================================
class TalentRemarkable(BasePassive):
    id = "remarkable"
    name = "Примечательный"
    description = (
        "2.1 Из-за вашего характера и метода, который вы используете, ваша репутация набирается быстрее, "
        "что в последствии даст больше заданий и больше связей."
    )
    is_active_ability = False

# ==========================================
# 2.2 На волне успеха
# ==========================================
class TalentOnTheWaveOfSuccess(BasePassive):
    id = "on_the_wave_of_success"
    name = "На волне успеха"
    description = (
        "2.2 После завершения задания вы восстанавливаете Рассудок пропорционально сложности задания (Вплоть до 30%).\n"
        "Также, когда вы находитесь в хорошем настроении и ваш Рассудок выше 90%, вы получаете +4 Харизмы (Красноречия)."
    )
    is_active_ability = False  # Делаем активным, чтобы можно было лечить SP кнопкой

    def on_calculate_stats(self, unit) -> dict:
        # Проверяем условие: SP > 90%
        if unit.max_sp > 0:
            ratio = unit.current_sp / unit.max_sp
            if ratio >= 0.9:
                return {"eloquence": 4}
        return {}


# ==========================================
# 2.3 Тактический анализ
# ==========================================
class TalentTacticalAnalysis(BasePassive):
    id = "tactical_analysis"
    name = "Тактический анализ"
    description = (
        "2.3 Пассивно: вы видите здоровье, выдержку, рассудок и сопротивления врага.\n"
        "Активно: Бросок Мудрости для определения скрытой информации.\n"
        "1-3: Детальное описание.\n"
        "4-6: Группа ассоциации.\n"
        "7-8: Количество кубов скорости.\n"
        "9-10: Мин/макс скорость.\n"
        "11-13: Слабые карты (I).\n"
        "14-16: Средние карты (II).\n"
        "17-20: Сильные карты (III).\n"
        "20-24: Мощные карты.\n"
        "25-30: Повысит откат карт врага на 1 (на 2 раунда).\n"
        "31-35: Раскроет пассивные умения.\n"
        "36+: Уязвимая точка (накладывает Уязвимость, -25% сопр. одного типа)."
    )
    is_active_ability = False


# ==========================================
# 2.4 Изучение Поведения
# ==========================================
class TalentBehaviorStudy(BasePassive):
    id = "behavior_study"
    name = "Изучение Поведения"
    description = (
        "2.4 Вы знаете своих друзей как свои 5 пальцев.\n"
        "Пассивно: Если ваш слот ПУСТОЙ и ваша Скорость выше Скорости врага на 8+,\n"
        "вы уничтожаете атакующие кубики врага, направленные в этот слот."
    )
    is_active_ability = False

    def can_break_empty_slot(self, unit) -> bool:
        """Разрешает ломать кубики врага пустым слотом при высокой скорости."""
        return True


# ==========================================
# 2.5 Мастер речи
# ==========================================
class TalentSpeechMaster(BasePassive):
    id = "speech_master"
    name = "Мастер речи"
    description = (
        "2.5 Теперь ваша кость броска красноречия равняется 1d10+10.\n"
        "Также скидка, которую вы можете получить, увеличивается на 10%."
    )
    is_active_ability = False
    # Логику изменения кости реализуем позже в механике скиллчеков


# ==========================================
# 2.6 Следопыт
# ==========================================
class TalentPathfinder(BasePassive):
    id = "pathfinder"
    name = "Следопыт"
    description = (
        "2.6 Вы отчётливо видите след другого человека, если он оставлен в течении 24 часов (без броска).\n"
        "Также вы знаете как замести след: те кто вас ищут, должны кидать интеллект с помехой."
    )
    is_active_ability = False


# ==========================================
# 2.7 Туз всех мастей
# ==========================================
class TalentAceOfAllTrades(BasePassive):
    id = "ace_of_all_trades"
    name = "Туз всех мастей"
    description = "2.7 Вы получаете +3 ко всем атрибутам и навыкам."
    is_active_ability = False

    def on_calculate_stats(self, unit) -> dict:
        # Простая логика, которую легко добавить сразу
        stats = {}
        for attr in unit.attributes: stats[attr] = 3
        for skill in unit.skills: stats[skill] = 3
        return stats


# ==========================================
# 2.8 Познай своего врага
# ==========================================
class TalentKnowYourEnemy(BasePassive):
    id = "know_your_enemy"
    name = "Познай своего врага"
    description = (
        "2.8 (Требует 20 Мудрости) В бою вы запоминаете каждое движение врага.\n"
        "После того как существо использует ранг атаки на вас, вы её запоминаете.\n"
        "При повторном использовании карты этого ранга против вас: +1 ко всем броскам в столкновении (макс +3).\n"
        "Прибавка держится 1 день."
    )
    is_active_ability = False


# ==========================================
# 2.9 А: Стратег
# ==========================================
class TalentStrategist(BasePassive):
    id = "strategist"
    name = "Стратег (А)"
    description = (
        "2.9 А: В вашей голове всегда происходит мозговой шторм.\n"
        "Когда вы замечаете существо, через 3 секунды вы мгновенно используете Тактический анализ (+10 к броску).\n"
        "Интеграция с 'Познай своего врага': вы мгновенно получаете прибавку +1 против карт, раскрытых Анализом."
    )
    is_active_ability = False


# ==========================================
# 2.9 Б: Всегда на готове
# ==========================================
class TalentAlwaysReady(BasePassive):
    id = "always_ready"
    name = "Всегда на готове (Б)"
    description = (
        "2.9 Б: Все ваши броски костей (помимо броска речи) будут равняться 1d12+8.\n"
        "Критический провал во время броска теперь невозможен."
    )
    is_active_ability = False