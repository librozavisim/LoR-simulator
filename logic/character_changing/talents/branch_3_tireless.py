from core.enums import DiceType
from logic.character_changing.passives.base_passive import BasePassive


# ==========================================
# 3.1 –ó–¥–æ—Ä–æ–≤—è–∫
# ==========================================
class TalentBigGuy(BasePassive):
    id = "big_guy"
    name = "–ó–¥–æ—Ä–æ–≤—è–∫"
    description = "3.1 –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ –Ω–∞ 15%."
    is_active_ability = False

    def on_calculate_stats(self, unit) -> dict:
        return {"max_hp_pct": 15}


# ==========================================
# 3.2 –û–±–æ—Ä–æ–Ω–∞ (–ü–µ—Ä–µ–Ω–æ—Å –∏–∑ zafiel_passives)
# ==========================================
class TalentDefense(BasePassive):
    id = "defense_zafu"  # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–∞ –ª–æ–≥–∏–∫–∞ –≤ unit_mixins
    name = "–û–±–æ—Ä–æ–Ω–∞"
    description = (
        "3.2 –ö–∞–∂–¥—ã–π —Ä–∞—É–Ω–¥ –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –∫–æ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ë–ª–æ–∫–∞ (5-7).\n"
        "3.5: +1 –ö–æ—Å—Ç—å. –ü–æ–±–µ–¥–∞ –±–ª–æ–∫–æ–º -> +1 –ó–∞—â–∏—Ç–∞.\n"
        "3.8: +1 –ö–æ—Å—Ç—å. –ü—Ä–æ–∏–≥—Ä—ã—à –±–ª–æ–∫–æ–º -> +1 –°–∏–ª–∞.\n"
        "3.10: +1 –ö–æ—Å—Ç—å –ö–æ–Ω—Ç—Ä-–±–ª–æ–∫–∞."
    )
    is_active_ability = False

    # –õ–æ–≥–∏–∫–∞ –≤—ã–¥–∞—á–∏ –∫—É–±–∏–∫–æ–≤ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ core/unit_mixins.py

    # ID —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –∫–∞—Ä—Ç—ã (–¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å unit_mixins)
    card_id_block = "zafu_block_card"

    def on_clash_win(self, ctx):
        # 3.5: –ü–æ–±–µ–¥–∞ -> +1 –ó–∞—â–∏—Ç–∞
        if ctx.source.current_card and ctx.source.current_card.id == self.card_id_block:
            if "talent_3_5" in ctx.source.talents:
                ctx.source.add_status("protection", 1, duration=1)
                ctx.log.append(f"üõ°Ô∏è **{self.name}**: –ü–æ–±–µ–¥–∞ -> +1 –ó–∞—â–∏—Ç–∞")

    def on_clash_lose(self, ctx):
        # 3.8: –ü—Ä–æ–∏–≥—Ä—ã—à -> +1 –°–∏–ª–∞ (–∂–µ–ª—Ç–∞—è —Å—Ç—Ä–µ–ª–∫–∞)
        if ctx.source.current_card and ctx.source.current_card.id == self.card_id_block:
            if "talent_3_8" in ctx.source.talents:
                ctx.source.add_status("strength", 1, duration=1)
                ctx.log.append(f"üí™ **{self.name}**: –ü—Ä–æ–∏–≥—Ä—ã—à -> +1 –°–∏–ª–∞")


# ==========================================
# 3.3 –ü–æ—Ö–≤–∞–ª—å–Ω–æ–µ —Ç–µ–ª–æ—Å–ª–æ–∂–µ–Ω–∏–µ
# ==========================================
class TalentCommendableConstitution(BasePassive):
    id = "commendable_constitution"
    name = "–ü–æ—Ö–≤–∞–ª—å–Ω–æ–µ —Ç–µ–ª–æ—Å–ª–æ–∂–µ–Ω–∏–µ"
    description = (
        "3.3 –ë—Ä–æ—Å–∫–∏ –°—Ç–æ–π–∫–æ—Å—Ç–∏ +2.\n"
        "–ü–∞—Å—Å–∏–≤–Ω–æ: +1 –°—Ç–æ–π–∫–æ—Å—Ç—å (Endurance). –ï—Å–ª–∏ –µ—Å—Ç—å 3.8 -> +2.\n"
        "–ê–∫—Ç–∏–≤–Ω–æ (1 —Ä–∞–∑ –≤ –¥–µ–Ω—å): –ö–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–¥—ã—Ö. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç 20% HP (30%, –µ—Å–ª–∏ –µ—Å—Ç—å 3.7)."
    )
    is_active_ability = True
    cooldown = 99  # 1 —Ä–∞–∑ –∑–∞ –±–æ–π/–¥–µ–Ω—å

    def on_calculate_stats(self, unit) -> dict:
        # –ë—Ä–æ—Å–∫–∏ —Å—Ç–æ–π–∫–æ—Å—Ç–∏ (–Ω–∞–≤—ã–∫ endurance) +2
        # –ü–∞—Å—Å–∏–≤–Ω—ã–π –±–∞—Ñ—Ñ +1 endurance_status —Ä–µ–∞–ª–∏–∑—É–µ–º —á–µ—Ä–µ–∑ on_combat_start –∏–ª–∏ —Ç—É—Ç –∂–µ?
        # –û–±—ã—á–Ω–æ —Å—Ç–∞—Ç—É—Å—ã –ª—É—á—à–µ –¥–∞–≤–∞—Ç—å –≤ –Ω–∞—á–∞–ª–µ –±–æ—è. –ù–æ —Ç—É—Ç "–ë—Ä–æ—Å–∫–∏ —Å—Ç–æ–π–∫–æ—Å—Ç–∏" —ç—Ç–æ –Ω–∞–≤—ã–∫.
        return {"endurance": 2}

    def on_combat_start(self, unit, log_func, **kwargs):
        # –ü–∞—Å—Å–∏–≤–Ω—ã–π –±–æ–Ω—É—Å –∫ —Å—Ç–∞—Ç—É—Å—É (–©–∏—Ç)
        amt = 1
        if "survivor" in unit.talents:  # 3.8
            amt += 1
        unit.add_status("endurance", amt, duration=99)
        if log_func: log_func(f"üõ°Ô∏è **{self.name}**: +{amt} Endurance")

    def activate(self, unit, log_func, **kwargs):
        if unit.cooldowns.get(self.id, 0) > 0: return False

        pct = 0.20
        if "tough_as_steel" in unit.talents:  # 3.7
            pct = 0.30

        heal = int(unit.max_hp * pct)
        actual = unit.heal_hp(heal)
        unit.cooldowns[self.id] = self.cooldown

        if log_func: log_func(f"üí§ **–û—Ç–¥—ã—Ö**: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ {actual} HP ({int(pct * 100)}%)")
        return True


# ==========================================
# 3.3 (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ë–æ–ª—å—à–æ–µ —Å–µ—Ä–¥—Ü–µ
# ==========================================
class TalentBigHeart(BasePassive):
    id = "big_heart"
    name = "–ë–æ–ª—å—à–æ–µ —Å–µ—Ä–¥—Ü–µ"
    description = (
        "3.3 –û–ø—Ü: –†–µ–∞–∫—Ü–∏–µ–π –º–æ–∂–Ω–æ –∑–∞—â–∏—Ç–∏—Ç—å —Å–æ—é–∑–Ω–∏–∫–∞, –ø–æ–¥—Å—Ç–∞–≤–∏–≤—à–∏—Å—å –ø–æ–¥ —É–¥–∞—Ä (–∏—Å–ø–æ–ª—å–∑—É—è –Ω–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ—Å—Ç–∏ –ë–ª–æ–∫–∞).\n"
        "–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–æ—Å—Ç–∏ –û–±–æ—Ä–æ–Ω—ã, —Å–æ—é–∑–Ω–∏–∫ –ø–æ–ª—É—á–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç—ã –Ω–∞–≤—ã–∫–∞."
    )
    is_active_ability = False


# ==========================================
# 3.4 –°–∫–∞–ª–∞
# ==========================================
class TalentRock(BasePassive):
    id = "rock"
    name = "–°–∫–∞–ª–∞"
    description = (
        "3.4 –ï—Å–ª–∏ –≤—ã –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç–µ —É—Ä–æ–Ω –ø—Ä–∏ –∞—Ç–∞–∫–µ (–±–ª–∞–≥–æ–¥–∞—Ä—è —Ä–µ–∑–∏—Å—Ç–∞–º/—Å—Ç–∞—Ç—É—Å–∞–º, –Ω–æ –Ω–µ –ë–ª–æ–∫—É),\n"
        "–≤–µ—Å—å —É—Ä–æ–Ω –æ—Ç—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –∞—Ç–∞–∫—É—é—â–µ–≥–æ."
    )
    is_active_ability = False


# ==========================================
# 3.5 –ù–µ –≤–∑–∏—Ä–∞—è –Ω–∞ –Ω–µ–≤–∑–≥–æ–¥—ã
# ==========================================
class TalentDespiteAdversities(BasePassive):
    id = "talent_3_5"  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —ç—Ç–æ—Ç ID –¥–ª—è —Å–≤—è–∑–∏ —Å –û–±–æ—Ä–æ–Ω–æ–π
    name = "–ù–µ –≤–∑–∏—Ä–∞—è –Ω–∞ –Ω–µ–≤–∑–≥–æ–¥—ã"
    description = (
        "3.5 –í –û–≥–ª—É—à–µ–Ω–∏–∏ —Ä–µ–∑–∏—Å—Ç—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è x1.5 (–≤–º–µ—Å—Ç–æ x2.0).\n"
        "–ö–æ—Å—Ç–∏ –Ω–∞–≤—ã–∫–∞ '–û–±–æ—Ä–æ–Ω–∞' –æ—Å—Ç–∞—é—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –¥–∞–∂–µ –≤ –û–≥–ª—É—à–µ–Ω–∏–∏.\n"
        "–ï—Å–ª–∏ –µ—Å—Ç—å 3.10 -> —Ä–µ–∑–∏—Å—Ç—ã x1.25."
    )
    is_active_ability = False

    # –õ–æ–≥–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ–∑–∏—Å—Ç–æ–≤ –≤ Stagger –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ calculations.py (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞)


# ==========================================
# 3.5 (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –¢–µ—Ä–º–æ—Å—Ç–æ–π–∫–∏–π
# ==========================================
class TalentHeatResistant(BasePassive):
    id = "heat_resistant"
    name = "–¢–µ—Ä–º–æ—Å—Ç–æ–π–∫–∏–π"
    description = "3.5 –û–ø—Ü: –£—Ä–æ–Ω –æ—Ç –û–≥–Ω—è –∏ –•–æ–ª–æ–¥–∞ —Å–Ω–∏–∂–µ–Ω –Ω–∞ 33%."
    is_active_ability = False


# ==========================================
# 3.6 –ê–¥–∞–ø—Ç–∞—Ü–∏—è
# ==========================================
class TalentAdaptationTireless(BasePassive):
    id = "adaptation_tireless"
    name = "–ê–¥–∞–ø—Ç–∞—Ü–∏—è (–¢–∏–ø 2)"
    description = (
        "3.6 –í –∫–æ–Ω—Ü–µ —Ä–∞—É–Ω–¥–∞ —Ä–µ–∑–∏—Å—Ç –∫ —Å–∞–º–æ–º—É —á–∞—Å—Ç–æ–º—É –ø–æ–ª—É—á–µ–Ω–Ω–æ–º—É —Ç–∏–ø—É —É—Ä–æ–Ω–∞ —Å–Ω–∏–∂–∞–µ—Ç—Å—è –Ω–∞ 0.25."
    )
    is_active_ability = False


# ==========================================
# 3.7 –ö—Ä–µ–ø–∫–∏–π –∫–∞–∫ —Å—Ç–∞–ª—å
# ==========================================
class TalentToughAsSteel(BasePassive):
    id = "tough_as_steel"
    name = "–ö—Ä–µ–ø–∫–∏–π –∫–∞–∫ —Å—Ç–∞–ª—å"
    description = (
        "3.7 –ú–∞–∫—Å. –ó–¥–æ—Ä–æ–≤—å–µ +20%.\n"
        "–ü–æ–±–µ–¥–∞ –∫–æ—Å—Ç—å—é –±–ª–æ–∫–∞ -> –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç 1 –•—Ä—É–ø–∫–æ—Å—Ç—å (Fragile) –Ω–∞ –≤—Ä–∞–≥–∞ (–º–∞–∫—Å 3)."
    )
    is_active_ability = False

    def on_calculate_stats(self, unit) -> dict:
        return {"max_hp_pct": 20}

    def on_clash_win(self, ctx):
        if ctx.dice.dtype == DiceType.BLOCK:
            target = ctx.target  # –¢–æ—Ç, —Å –∫–µ–º —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ (–∞—Ç–∞–∫—É—é—â–∏–π)
            if target:
                # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ "–Ω–µ –±–æ–ª—å—à–µ 3" —Å–ª–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–µ–∑ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—É–Ω–¥–∞, 
                # –Ω–æ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ª–æ–∂–∏–º
                target.add_status("fragile", 1, duration=1)
                ctx.log.append(f"üß± **{self.name}**: –í—Ä–∞–≥ –ø–æ–ª—É—á–∏–ª +1 –•—Ä—É–ø–∫–æ—Å—Ç—å")


# ==========================================
# 3.7 (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ó–∞—â–∏—Ç–Ω–∏–∫
# ==========================================
class TalentDefender(BasePassive):
    id = "defender"
    name = "–ó–∞—â–∏—Ç–Ω–∏–∫"
    description = (
        "3.7 –û–ø—Ü: –°–æ—é–∑–Ω–∏–∫–∏ –ø–æ–ª—É—á–∞—é—Ç 4 –ó–∞—â–∏—Ç—ã –≤ –ø–µ—Ä–≤–æ–º —Ä–∞—É–Ω–¥–µ.\n"
        "–ú–æ–∂–Ω–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å —É–¥–∞—Ä—ã –∑–∞ —Å–æ—é–∑–Ω–∏–∫–æ–≤ –±–µ–∑ –∫–æ—Å—Ç–µ–π –±–ª–æ–∫–∞ (–ø–æ–ª—É—á–∞—è +1 –°–∏–ª—É –∑–∞ –∫–∞–∂–¥—ã–π —É–¥–∞—Ä)."
    )
    is_active_ability = False

    def on_combat_start(self, unit, log_func, **kwargs):
        # –í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ —Å–ª–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ "—Å–æ—é–∑–Ω–∏–∫–æ–≤", –Ω–∞–ª–æ–∂–∏–º –Ω–∞ —Å–µ–±—è –∫–∞–∫ –∞—É—Ä—É
        if log_func: log_func(f"üõ°Ô∏è **{self.name}**: –ê—É—Ä–∞ –∑–∞—â–∏—Ç—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞.")


# ==========================================
# 3.8 –í—ã–∂–∏–≤—à–∏–π
# ==========================================
class TalentSurvivor(BasePassive):
    id = "talent_3_8"  # –°–≤—è–∑—å —Å –û–±–æ—Ä–æ–Ω–æ–π
    name = "–í—ã–∂–∏–≤—à–∏–π"
    description = (
        "3.8 –ë—Ä–æ—Å–∫–∏ –°—Ç–æ–π–∫–æ—Å—Ç–∏ —Å –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ–º.\n"
        "–í–Ω–µ–∑–∞–ø–Ω–∞—è –∞—Ç–∞–∫–∞ –Ω–∞–Ω–æ—Å–∏—Ç x1.5 —É—Ä–æ–Ω–∞ (–≤–º–µ—Å—Ç–æ x2.0).\n"
        "–£—Ä–æ–Ω –æ—Ç –ö—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏—è —Å–Ω–∏–∂–µ–Ω –Ω–∞ 33%.\n"
        "–ê–∫—Ç–∏–≤–Ω–æ: –ï—Å–ª–∏ –≤ —Ä–∞—É–Ω–¥–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –∫–æ—Å—Ç–∏ -> –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å 15% HP."
    )
    is_active_ability = True
    cooldown = 99

    def activate(self, unit, log_func, **kwargs):
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ "–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –∫–æ—Å—Ç–∏" (—Å–ª–æ–∂–Ω–æ, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –∏–≥—Ä–æ–∫ —á–µ—Å—Ç–Ω—ã–π)
        if unit.cooldowns.get(self.id, 0) > 0: return False

        heal = int(unit.max_hp * 0.15)
        unit.heal_hp(heal)
        unit.cooldowns[self.id] = self.cooldown
        if log_func: log_func(f"‚ù§Ô∏è **–í—ã–∂–∏–≤—à–∏–π**: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ {heal} HP")
        return True


# ==========================================
# 3.9 –ü–µ—Ä–µ–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –º—ã—à—Ü
# ==========================================
class TalentMuscleOverstrain(BasePassive):
    id = "muscle_overstrain"
    name = "–ü–µ—Ä–µ–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –º—ã—à—Ü"
    description = "3.9 –ê–∫—Ç–∏–≤–Ω–æ: –ü–æ—Ç—Ä–∞—Ç–∏—Ç—å 5 HP –∏–ª–∏ 10 Stagger -> +1 –ú–æ—â—å –∫—É–±–∏–∫–æ–≤ (2 —Ä–∞–∑–∞/—Ä–∞—É–Ω–¥)."
    is_active_ability = True

    def activate(self, unit, log_func, **kwargs):
        # –¢—Ä–∞—Ç–∏–º 5 HP
        unit.current_hp = max(1, unit.current_hp - 5)
        unit.add_status("strength", 1, duration=1)
        if log_func: log_func("üí™ **–ü–µ—Ä–µ–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ**: -5 HP -> +1 –°–∏–ª–∞")
        return True


# ==========================================
# 3.9 (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ö–ª—è—Ç–≤–∞ –∏–¥–æ–ª–∞
# ==========================================
class TalentIdolOath(BasePassive):
    id = "idol_oath"
    name = "–ö–ª—è—Ç–≤–∞ –∏–¥–æ–ª–∞"
    description = (
        "3.9 –û–ø—Ü: –í—ã –æ—Ç–∫–∞–∑—ã–≤–∞–µ—Ç–µ—Å—å –æ—Ç –ª–µ—á–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö.\n"
        "–ú–µ–¥–∏—Ü–∏–Ω–∞ +15.\n"
        "HP < 25% -> +2 –ú–æ—â—å.\n"
        "–ö—Ä–µ–ø–∫–∞—è –∫–æ–∂–∞ +15."
    )
    is_active_ability = False

    def on_calculate_stats(self, unit) -> dict:
        mods = {"medicine": 15, "tough_skin": 15}
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ HP < 25%
        if unit.max_hp > 0 and (unit.current_hp / unit.max_hp) < 0.25:
            mods["power_all"] = 2  # –ì–∏–ø–æ—Ç–µ—Ç–∏—á–µ—Å–∫–∏–π –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–æ –≤—Å–µ–º –±—Ä–æ—Å–∫–∞–º
        return mods


# ==========================================
# 3.10 –ü—Ä–∏–ª–∏–≤ —Å–∏–ª
# ==========================================
class TalentSurgeOfStrength(BasePassive):
    id = "talent_3_10"  # –°–≤—è–∑—å —Å –û–±–æ—Ä–æ–Ω–æ–π
    name = "–ü—Ä–∏–ª–∏–≤ —Å–∏–ª"
    description = (
        "3.10 HP < 25% -> –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –≤—ã—Ö–æ–¥ –∏–∑ –û–≥–ª—É—à–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–±—Ä–æ—Å –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã.\n"
        "–î–æ –∫–æ–Ω—Ü–∞ —Ä–∞—É–Ω–¥–∞: +4 –°–∏–ª—ã, –°—Ç–æ–π–∫–æ—Å—Ç–∏, –°–ø–µ—à–∫–∏, –ó–∞—â–∏—Ç—ã.\n"
        "–î–∞–ª–µ–µ –¥–æ –∫–æ–Ω—Ü–∞ –±–æ—è: +2 –°–ø–µ—à–∫–∏, –û—Ç–∫–∞—Ç—ã -1."
    )
    is_active_ability = False

    # –õ–æ–≥–∏–∫–∞ "HP < 25%" –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å—Å—è –≤ on_take_damage –∏–ª–∏ on_round_start