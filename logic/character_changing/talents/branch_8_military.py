from logic.character_changing.passives.base_passive import BasePassive


# ==========================================
# 8.1 –ê—Ç–ª–µ—Ç–∏—á–Ω—ã–π
# ==========================================
class TalentAthletic(BasePassive):
    id = "athletic"
    name = "–ê—Ç–ª–µ—Ç–∏—á–Ω—ã–π"
    description = (
        "8.1 haste +1.\n"
        "–í—ã –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –∞—Ç–∞–∫–∏ –ø—Ä–∏ –†–ê–í–ù–û–ô —Å–∫–æ—Ä–æ—Å—Ç–∏ (–æ–±—ã—á–Ω–æ –Ω—É–∂–Ω–æ —Å—Ç—Ä–æ–≥–æ –±–æ–ª—å—à–µ)."
    )
    is_active_ability = False

    def on_round_start(self, unit, log_func, **kwargs):
        unit.add_status("haste", 1, 1)

    def can_redirect_on_equal_speed(self, unit) -> bool:
        return True


# ==========================================
# 8.2 –ë—ã—Å—Ç—Ä—ã–µ —Ä—É–∫–∏
# ==========================================
class TalentFastHands(BasePassive):
    id = "fast_hands"
    name = "–ë—ã—Å—Ç—Ä—ã–µ —Ä—É–∫–∏"
    description = (
        "8.2 –û–≥–Ω–µ—Å—Ç—Ä–µ–ª—å–Ω–æ–µ –æ—Ä—É–∂–∏–µ +3.\n"
        "–í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –∫–∞—Ä—Ç—É '–ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞' (–±–µ–∑ –∫–æ—Å—Ç–µ–π, –¥–µ–π—Å—Ç–≤–∏–µ). –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞."
    )
    is_active_ability = True

    def on_calculate_stats(self, unit) -> dict:
        return {"firearms": 3}

    def activate(self, unit, log_func, **kwargs):
        # –ó–∞–≥–ª—É—à–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç—ã –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∏
        if log_func: log_func("üî´ **–ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞**: –ú–∞–≥–∞–∑–∏–Ω –ø–æ–ª–æ–Ω (—Å–∏–º—É–ª—è—Ü–∏—è).")
        return True


# ==========================================
# 8.3 –õ–∏–¥–µ—Ä
# ==========================================
class TalentLeader(BasePassive):
    id = "leader"
    name = "–õ–∏–¥–µ—Ä WIP"
    description = (
        "8.3 –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —É—Ä–æ–Ω–∞ –∑–∞ –∫–∞–∂–¥–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ—é–∑–Ω–∏–∫–∞ (–º–∞–∫—Å +3).\n"
        "–°–æ—é–∑–Ω–∏–∫–∏ –ø–æ–ª—É—á–∞—é—Ç 2 –ó–∞—â–∏—Ç—ã.\n"
        "–ú–∏–Ω—É—Å—ã: –í–∞—à–µ –ø–∞–¥–µ–Ω–∏–µ/—Å–º–µ—Ä—Ç—å –Ω–∞–Ω–æ—Å–∏—Ç –æ–≥—Ä–æ–º–Ω—ã–π —É—Ä–æ–Ω –ø–æ SP —Å–æ—é–∑–Ω–∏–∫–æ–≤ (-25% / -50%)."
    )
    is_active_ability = False

    def on_combat_start(self, unit, log_func, **kwargs):
        # –í —Å–∏–º—É–ª—è—Ç–æ—Ä–µ 1 –Ω–∞ 1 —Å–ª–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞—É—Ä—É –Ω–∞ —Å–æ—é–∑–Ω–∏–∫–æ–≤.
        # –ü—Ä–æ—Å—Ç–æ –ø–∏—à–µ–º –≤ –ª–æ–≥.
        if log_func: log_func(f"üö© **{self.name}**: –ê—É—Ä–∞ –ª–∏–¥–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞ (+–£—Ä–æ–Ω –≤–∞–º, +–ó–∞—â–∏—Ç–∞ —Å–æ—é–∑–Ω–∏–∫–∞–º).")


# ==========================================
# 8.4 Addiction is a bitch
# ==========================================
class TalentAddiction(BasePassive):
    id = "addiction_is_a_bitch"
    name = "Addiction is a bitch"
    description = (
        "8.4 –ê–∫—Ç–∏–≤–Ω–æ (–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –≤–µ—â–µ—Å—Ç–≤–∞): –í–æ—Å—Å—Ç. 10% SP/—Ä–∞—É–Ω–¥ (3 —Ä–∞—É–Ω–¥–∞).\n"
        "–ë–∞—Ñ—Ñ—ã –Ω–∞ 3 —Ä–∞—É–Ω–¥–∞: +1 –°–∏–ª–∞, +1 –°–∫–æ—Ä–æ—Å—Ç—å, –ò–º–º—É–Ω–∏—Ç–µ—Ç –∫ –ü–∞—Ä–∞–ª–∏—á—É."
    )
    is_active_ability = True
    cooldown = 20  # –£—Å–ª–æ–≤–Ω–æ 2 —á–∞—Å–∞

    def activate(self, unit, log_func, **kwargs):
        if unit.cooldowns.get(self.id, 0) > 0: return False

        duration = 3
        unit.add_status("strength", 1, duration=duration)
        unit.add_status("haste", 1, duration=duration)  # –°–∫–æ—Ä–æ—Å—Ç—å
        # –ò–º–º—É–Ω–∏—Ç–µ—Ç –∫ –ø–∞—Ä–∞–ª–∏—á—É —Å–ª–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –±–µ–∑ —Å–ø–µ—Ü. —Å—Ç–∞—Ç—É—Å–∞ "immune_paralysis"

        # –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—é SP —Ä–µ–∞–ª–∏–∑—É–µ–º —á–µ—Ä–µ–∑ —Å—Ç–∞—Ç—É—Å –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –¥–∞–¥–∏–º —á–∞—Å—Ç—å
        heal_sp = int(unit.max_sp * 0.10)
        unit.restore_sp(heal_sp)

        unit.cooldowns[self.id] = self.cooldown
        if log_func: log_func(f"üíä **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å**: –ü—Ä–∏–ª–∏–≤ —Å–∏–ª! (+{heal_sp} SP, +Str, +Spd)")
        return True


# ==========================================
# 8.5 –ë—ã—Å—Ç—Ä–æ–µ –æ—Ç—Å—Ç—É–ø–ª–µ–Ω–∏–µ
# ==========================================
class TalentRapidRetreat(BasePassive):
    id = "rapid_retreat"
    name = "–ë—ã—Å—Ç—Ä–æ–µ –æ—Ç—Å—Ç—É–ø–ª–µ–Ω–∏–µ"
    description = "8.5 –ï—Å–ª–∏ –ø–æ—Ç–µ—Ä—è–Ω–æ > 25% HP –∑–∞ —Ä–∞—É–Ω–¥ -> –°—Ç–∞—Ç—É—Å '–ù–µ–∑–∞–º–µ—Ç–Ω—ã–π' –Ω–∞ 1 —Ä–∞—É–Ω–¥."
    is_active_ability = False

    # –õ–æ–≥–∏–∫–∞ —Ç—Ä–µ–±—É–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É—Ä–æ–Ω–∞ –∑–∞ —Ä–∞—É–Ω–¥ (on_take_damage + reset –≤ –∫–æ–Ω—Ü–µ —Ä–∞—É–Ω–¥–∞)


# ==========================================
# 8.6 –ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞ (–ë–æ–µ–≤–∞—è)
# ==========================================
class TalentCombatReload(BasePassive):
    id = "combat_reload"
    name = "–ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞ (–ë–æ–µ–≤–∞—è)"
    description = (
        "8.6 –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –∫–∞—Ä—Ç—É '–ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞' (–ë–ª–æ–∫ + –£–∫–ª–æ–Ω–µ–Ω–∏–µ).\n"
        "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–µ—Ä–µ–∑–∞—Ä—è–∂–∞–µ—Ç –æ—Ä—É–∂–∏–µ."
    )
    is_active_ability = False
    # –°–∞–º–∞ –∫–∞—Ä—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∫–æ–ª–æ–¥—É –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (Library logic)


# ==========================================
# 8.7 –ù–∞–π—Ç–∏ —É—è–∑–≤–∏–º–æ—Å—Ç—å
# ==========================================
class TalentFindVulnerability(BasePassive):
    id = "find_vulnerability"
    name = "–ù–∞–π—Ç–∏ —É—è–∑–≤–∏–º–æ—Å—Ç—å"
    description = (
        "8.7 –ü–µ—Ä–≤–∞—è –∞—Ç–∞–∫–∞ –ø–æ –≤—Ä–∞–≥—É –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç –ú–µ—Ç–∫—É.\n"
        "–ú–µ—Ç–∫–∞: +25% —É—Ä–æ–Ω–∞ –ø–æ –≤—Ä–∞–≥—É –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥."
    )
    is_active_ability = False

    def on_hit(self, ctx, **kwargs):
        stack = kwargs.get("stack", 0)
        # –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø–µ—Ä–≤–∞—è –ª–∏ —ç—Ç–æ –∞—Ç–∞–∫–∞ –∑–∞ —Ä–∞—É–Ω–¥.
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞–º—è—Ç—å —é–Ω–∏—Ç–∞.
        if not ctx.target: return

        flag = f"marked_target_{ctx.source.name}_{ctx.round_idx}"
        if not ctx.source.memory.get(flag):
            ctx.source.memory[flag] = True
            # –ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å (Vulnerability +25% —É—Ä–æ–Ω–∞)
            # –í –¥–≤–∏–∂–∫–µ Vulnerability –æ–±—ã—á–Ω–æ +1 —É—Ä–æ–Ω. –î–ª—è +25% –Ω—É–∂–µ–Ω —Å–ø–µ—Ü —Å—Ç–∞—Ç—É—Å –∏–ª–∏ Fragile.
            ctx.target.add_status("vulnerability", 3, duration=2)
            ctx.log.append(f"üéØ **{self.name}**: –¶–µ–ª—å –ø–æ–º–µ—á–µ–Ω–∞ (–£—è–∑–≤–∏–º–æ—Å—Ç—å)!")


# ==========================================
# 8.8 –û–¥–æ–ª–∂–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è
# ==========================================
class TalentBorrowedTime(BasePassive):
    id = "borrowed_time"
    name = "–û–¥–æ–ª–∂–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è"
    description = (
        "8.8 –ü–∞—Å—Å–∏–≤–Ω–æ: –ï—Å–ª–∏ —Å–æ—é–∑–Ω–∏–∫ —É—Ö–æ–¥–∏—Ç –≤ Stagger -> –í–æ—Å—Å—Ç. 25% –í—ã–¥–µ—Ä–∂–∫–∏ –∏ –æ—Ç–º–µ–Ω—è–µ—Ç Stagger.\n"
        "(1 —Ä–∞–∑ –Ω–∞ —Å–æ—é–∑–Ω–∏–∫–∞ –≤ –¥–µ–Ω—å)."
    )
    is_active_ability = False


# ==========================================
# 8.9 –ñ–µ–ª–µ–∑–Ω—ã–π —Å—Ç—Ä–æ–π
# ==========================================
class TalentIronFormation(BasePassive):
    id = "iron_formation"
    name = "–ñ–µ–ª–µ–∑–Ω—ã–π —Å—Ç—Ä–æ–π"
    description = (
        "8.9 –í–µ—Å—å –æ—Ç—Ä—è–¥ –ø–æ–ª—É—á–∞–µ—Ç +3 –∫–æ –≤—Å–µ–º –Ω–∞–≤—ã–∫–∞–º.\n"
        "–û–±—â–∏–µ —Ä–µ—Ü–µ–ø—Ç—ã –∏ –æ–±–º–µ–Ω —Ç–∞–ª–∞–Ω—Ç–∞–º–∏ (–¥–æ 5 —É—Ä–æ–≤–Ω—è)."
    )
    is_active_ability = False

    def on_calculate_stats(self, unit) -> dict:
        # –ü–æ–∫–∞ –¥–∞–µ–º –±–æ–Ω—É—Å —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É (–≤ —Å–∏–Ω–≥–ª —Å–∏–º—É–ª—è—Ç–æ—Ä–µ)
        stats = {}
        for skill in unit.skills:
            stats[skill] = 3
        return stats


# ==========================================
# 8.10 –ü–æ—Å–ª–µ–¥–Ω—è—è –Ω–∞–¥–µ–∂–¥–∞
# ==========================================
class TalentLastHope(BasePassive):
    id = "last_hope"
    name = "–ü–æ—Å–ª–µ–¥–Ω—è—è –Ω–∞–¥–µ–∂–¥–∞ WIP"
    description = (
        "8.10 –ï—Å–ª–∏ –≤—ã –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–∂–∏–≤—à–∏–π: +2 –°—Ç–æ–π–∫–æ—Å—Ç—å, +2 –°–∏–ª–∞, +2 –ó–∞—â–∏—Ç–∞.\n"
        "+2 –ü–∞—Ç—Ä–æ–Ω–∞ –∫–∞–∂–¥—ã–π —Ä–∞—É–Ω–¥."
    )
    is_active_ability = False

    def on_combat_start(self, unit, log_func, **kwargs):
        # –ó–∞–≥–ª—É—à–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ "–ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–∂–∏–≤—à–∏–π"
        # –í –¥—É—ç–ª–∏ 1 –Ω–∞ 1 —ç—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–≤—ã –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –æ–¥–Ω–∏),
        # –Ω–æ –µ—Å–ª–∏ —Å—á–∏—Ç–∞—Ç—å —á—Ç–æ "–∫–æ–º–∞–Ω–¥–∞ –º–µ—Ä—Ç–≤–∞"...
        pass